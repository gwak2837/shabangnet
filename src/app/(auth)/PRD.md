# PRD: 사내 관리자 도구 인증 시스템

## 1. 개요 및 배경 (Overview)

better-auth 프레임워크의 모범 사례를 따르는 인증 시스템입니다. 회원가입 후 온보딩에서 MFA(다중 요소 인증)를 설정하여 보안을 강화합니다.

## 2. 핵심 정책 (Key Policies)

1. **비밀번호 필수:** 이메일/비밀번호 가입 시 강력한 비밀번호 정책을 적용한다.
2. **MFA 필수:** 모든 계정은 온보딩 과정에서 MFA를 설정해야 한다.
3. **관리자 승인:** 신규 가입자는 관리자 승인 후 서비스를 이용할 수 있다.
4. **No Self-Service Recovery:** 계정 분실(백업 코드 분실 포함) 시, 반드시 **최고 관리자(Super Admin)**에게 요청해야 한다.

## 3. 상세 기능 요구사항 (Functional Requirements)

### 3.1 회원가입 (Registration)

#### Case A: 이메일/비밀번호 가입

1. 이름, 이메일, 비밀번호 입력
2. 비밀번호 강도 검증 (8자 이상, 대소문자, 숫자, 특수문자)
3. 가입 완료 → 온보딩으로 이동

#### Case B: Google 소셜 로그인 가입

1. Google OAuth 인증
2. 계정 생성 → 온보딩으로 이동

### 3.2 온보딩 (MFA 설정)

온보딩은 가입 후 **필수** 단계입니다. MFA 설정을 완료해야 서비스를 이용할 수 있습니다.

#### 비밀번호 사용자

TOTP 또는 패스키 중 선택:

- **TOTP**: 비밀번호 재입력 → 인증 앱 QR 스캔 → 코드 입력 → 백업 코드 확인
- **패스키**: WebAuthn 생체 인식 등록

#### 소셜 로그인 사용자

better-auth 제약으로 패스키만 선택 가능:

- **패스키**: WebAuthn 생체 인식 등록

### 3.3 로그인 (Authentication)

- **패스키 등록 유저:**
  - Primary: 패스키로 로그인 (비밀번호 + MFA 생략)
  - Alternative: 비밀번호 + TOTP로 로그인

- **TOTP만 등록 유저:**
  - 비밀번호 입력 → TOTP 코드 입력

- **소셜 로그인 유저:**
  - Google 인증 → 패스키로 추가 인증 (선택)

### 3.4 세션 정책 (Session Management)

- **세션 유지 시간:** 7일
- **쿠키 캐시:** 5분
- **로그인 유지:** 체크박스 제공

### 3.5 계정 복구 (Recovery)

- **백업 코드 사용:**
  - MFA 진행 도중 [백업 코드 사용] 선택
  - 코드 검증 성공 시 로그인 처리
  - 로그인 후 보안 설정 재확인 권장

## 4. UI/UX 시나리오 (Wireframe Logic)

### A. 회원가입 플로우

```
[회원가입 페이지]
    ├── 이름 입력
    ├── 이메일 입력
    ├── 비밀번호 입력 (강도 표시)
    ├── 비밀번호 확인
    └── [가입하기] 버튼 → /onboarding
        또는
    └── [Google로 가입] 버튼 → /onboarding
```

### B. 온보딩 플로우 (비밀번호 사용자)

```
[MFA 방식 선택]
    ├── [패스키 (권장)] → 생체 인식 → 완료
    └── [인증 앱 (TOTP)] → 비밀번호 입력 → QR 스캔 → 코드 입력 → 백업 코드 확인 → 완료
```

### C. 온보딩 플로우 (소셜 로그인 사용자)

```
[패스키 등록]
    └── 생체 인식 → 완료
```

### D. 로그인 플로우

```
[로그인 페이지]
    ├── [패스키로 로그인] → 생체 인식 → 성공 (MFA 불필요)
    ├── 이메일/비밀번호 입력 → [로그인] → MFA 입력 → 성공
    └── [Google로 로그인] → OAuth → 성공
```

## 5. 기술적 요구사항 (Technical Requirements)

- **프레임워크:** better-auth (TypeScript)
- **플러그인:**
  - `twoFactor`: TOTP 및 백업 코드
  - `passkey`: WebAuthn/FIDO2 패스키
- **DB 스키마:**
  - `user`: 사용자 정보 + `status`, `onboardingComplete`, `authType`, `isAdmin`
  - `account`: 계정 정보 (credential, google 등)
  - `session`: 세션 관리
  - `twoFactor`: TOTP 비밀키 및 백업 코드
  - `passkey`: WebAuthn 크레덴셜 정보

### better-auth 제약 사항

- **소셜 계정 TOTP 불가:** better-auth에서 소셜 계정은 TOTP를 활성화할 수 없음
- **TOTP 활성화 시 비밀번호 필요:** credential 계정만 TOTP 활성화 가능

## 6. QA 및 테스트 시나리오 (Acceptance Criteria)

1. [ ] 이메일/비밀번호 가입 후 온보딩으로 이동하는가?
2. [ ] 온보딩에서 TOTP 선택 시 비밀번호 입력 화면이 표시되는가?
3. [ ] TOTP 활성화 후 QR 코드가 표시되고 인증 코드 입력이 되는가?
4. [ ] 패스키 선택 시 생체 인식 등록이 되는가?
5. [ ] Google 가입 시 온보딩에서 패스키 등록만 표시되는가?
6. [ ] MFA 설정 완료 후 승인 대기 페이지로 이동하는가?
7. [ ] 패스키 사용자가 패스키로 로그인할 수 있는가?
8. [ ] TOTP 사용자가 비밀번호 + TOTP로 로그인할 수 있는가?
9. [ ] 백업 코드로 MFA를 대체할 수 있는가?
10. [ ] 신규 가입자가 관리자 승인 전 서비스 이용이 차단되는가?
11. [ ] 가입 중 이탈 후 재로그인 시 온보딩에서 MFA 설정을 완료할 수 있는가?
